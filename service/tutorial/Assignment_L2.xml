<?xml version="1.0" encoding="UTF-8"?>
<services xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/service-definition-2.1.xsd">

    <!--///////// 1st ///////-->

    <service verb="post" noun="Orders">
        <in-parameters>
            <parameter name="currencyUomId" default="USD"/>
            <parameter name="statusId" default="OrderPlaced"/>
            <parameter name="orderName" required="true"/>
            <parameter name="placedDate" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="orderId"/>
        </out-parameters>
        <actions>
            <service-call name="create#mantle.order.OrderHeader" in-map="context" out-map="context"/>
        </actions>

    </service>


    <!--    /////////////////////// 2nd //////////////////////-->

    <service verb="post" noun="OrderEntity">

        <in-parameters>

            <parameter name="orderId" required="true"/>
            <parameter name="partName" required="true"/>
            <parameter name="facilityId" required="true"/>
            <parameter name="shipmentMethodEnumId" default="ShMthGround"/>
            <parameter name="customerPartyId" default="CustJqp"/>

            <parameter name="item_details" type="List" required="true">

                <parameter name="itemMap" type="Map">

                    <parameter name="productId" required="true"/>
                    <parameter name="facilityId" required="true"/>
                    <parameter name="itemDescription"/>
                    <parameter name="quantity" required="true"/>
                    <parameter name="unitAmount" required="true"/>
                </parameter>
            </parameter>
        </in-parameters>
        <out-parameters>
            <!-- Return Order Id and orderPartSeqId Id -->
            <parameter name="orderId"/>
            <parameter name="orderPartSeqId"/>

        </out-parameters>


        <actions>
            <service-call name="create#mantle.order.OrderHeader" out-map="context" in-map="[orderId:orderId]"/>

            <service-call name="create#mantle.order.OrderPart" out-map="orderPartOut" in-map="context + [orderId:orderId,partName:partName,
                            facilityId:facilityId,shipmentMethodEnumId:shipmentMethodEnumId,customerPartyId:customerPartyId]"/>

            <iterate list="item_details" entry="itemDetailMap">

                <service-call name="create#mantle.order.OrderItem" out-map="context" in-map="[

                                 orderPartSeqId : orderPartOut ?. orderPartSeqId,
                                 orderId:orderId,productId:productId,facilityId:facilityId,itemDescription:itemDescription,quantity:quantity,
                                 unitAmount:unitAmount]"/>
                <set field="orderPartSeqId" from="orderPartOut.orderPartSeqId"/>
                <!--                    <log message="================================${orderPartSeqId}================================"/>-->
            </iterate>
        </actions>
    </service>


    <!--    /////////////////////// 3rd //////////////////////-->

    <service verb="get" noun="AllOrder">
        <out-parameters>
            <parameter name="orders" type="List">
                <parameter name="orderMap" type="Map">
                    <parameter name="orderId"/>
                    <parameter name="orderName"/>
                    <parameter name="currencyUom"/>
                    <parameter name="salesChannelEnumId"/>
                    <parameter name="statusId"/>
                    <parameter name="placedDate"/>
                    <parameter name="grandTotal"/>

                    <parameter name="customer_details" type="List">
                        <parameter name="customer_details" type="Map">
                            <parameter name="firstName"/>
                            <parameter name="middleName"/>
                            <parameter name="lastName"/>

                        </parameter>
                    </parameter>

                    <parameter name="order_parts" type="List" required="true">

                        <parameter name="partMap" type="Map">

                            <parameter name="orderPartSeqId"/>
                            <parameter name="partName"/>
                            <parameter name="facilityId"/>
                            <parameter name="shipmentMethodEnumId"/>
                            <parameter name="partStatusId"/>
                            <parameter name="partTotal"/>
                        </parameter>

                        <parameter name="item_details" type="List">

                            <parameter name="orderItm_Map" type="Map">
                                <parameter name="orderItemSeqId"/>
                                <parameter name="productId"/>
                                <parameter name="itemDescription"/>
                                <parameter name="quantity"/>
                                <parameter name="unitAmount"/>
                            </parameter>
                        </parameter>
                    </parameter>
                </parameter>
            </parameter>

        </out-parameters>
        <actions>
            <entity-find entity-name="OrderHeader" list="orderHeaderList"/>
            <set field="orderDetailsMap" from="[:]"/>
            <iterate list="orderHeaderList" entry="orderHeader">

                <set field="orderDetailsMap" from="[orderId:orderHeader.orderId,orderName:orderHeader.orderName,currencyUom:orderHeader.currencyUom,salesChannelEnumId:orderHeader.salesChannelEnumId,
                            statusId:orderHeader.statusId,placedDate:orderHeader.placedDate,grandTotal:orderHeader.grandTotal]"/>
                <entity-find entity-name="OrderPart" list="orderPartList">
                    <econdition field-name="orderId" operator="equals" from="OrderHeader.orderId"/>
                </entity-find>
                <iterate list="orderPartList" entry="orderPart">
                    <set field="orderPartMap" from="[:]"/>
                    <set field="orderPartMap" from="[orderPartSeqId:orderPart.orderPartSeqId,partName:orderPart.partName,facilityId:orderPart.facilityId,shipmentMethodEnumId:orderPart.shipmentMethodEnumId,

                                   partStatusId:orderPart.partStatusId,partTotal:orderPart.partTotal]"/>
                    <script>orderPartList.add(orderPartMap)</script>
                </iterate>

                <entity-find entity-name="Person" list="personList">
                    <econdition field-name="partyId" operator="equals" from="OrderPart.customerPartyId"/>
                </entity-find>

                <iterate list="personList" entry="personMap">
                    <set field="personMap" from="[:]"/>
                    <set field="personMap"
                         from="[firstName:person.firstName,middleName:person.middleName,lastName:person.lastName]"/>


                    <script>personList.add(personMap)</script>


                </iterate>
                <entity-find entity-name="OrderItem" list="orderItemList">
                    <econdition field-name="orderPartSeqId" operator="equals" from="OrderPart.orderPartSeqId"/>
                    <econdition field-name="orderId" operator="equals" from="OrderHeader.orderId"/>
                </entity-find>
                <iterate list="orderItemList" entry="orderItem">
                    <set field="orderItemMap" from="[:]"/>
                    <set field="orderItemMap" from="[orderItemSeqId:orderItem.orderItemSeqId,productId:orderItem.productId,itemDescription:order.itemDescription,
                                             quantity:orderItem.quantity,unitAmount:orderItem.unitAmount]"/>

                    <script>orderItemList.add(orderItemMap)</script>

                </iterate>

                <set field="orderMap"
                     from="orderMap.add(customer_details:personMap) + [order_parts:orderPartList, item_details:orderItemList]"/>

                <script>orders.add(orderMap)</script>
            </iterate>


        </actions>

    </service>
    <service verb="get" noun="AllOrder">
        <out-parameters>
            <parameter name="orders" type="List">
                <parameter name="orderMap" type="Map">
                    <parameter name="orderId"/>
                    <parameter name="orderName"/>
                    <parameter name="currencyUom"/>
                    <parameter name="salesChannelEnumId"/>
                    <parameter name="statusId"/>
                    <parameter name="placedDate"/>
                    <parameter name="grandTotal"/>

                    <parameter name="customer_details" type="List">
                        <parameter name="customer_details" type="Map">
                            <parameter name="firstName"/>
                            <parameter name="middleName"/>
                            <parameter name="lastName"/>

                        </parameter>
                    </parameter>

                    <parameter name="order_parts" type="List" required="true">

                        <parameter name="partMap" type="Map">

                            <parameter name="orderPartSeqId"/>
                            <parameter name="partName"/>
                            <parameter name="facilityId"/>
                            <parameter name="shipmentMethodEnumId"/>
                            <parameter name="partStatusId"/>
                            <parameter name="partTotal"/>


                        <parameter name="item_details" type="List">

                            <parameter name="orderItm_Map" type="Map">
                                <parameter name="orderItemSeqId"/>
                                <parameter name="productId"/>
                                <parameter name="itemDescription"/>
                                <parameter name="quantity"/>
                                <parameter name="unitAmount"/>
                            </parameter>

                        </parameter>
                        </parameter>
                    </parameter>
                </parameter>
            </parameter>

        </out-parameters>
        <actions>
            <entity-find entity-name="OrderHeader" list="orderHeaderList"/>
            <set field="orderDetailsMap" from="[:]"/>
            <iterate list="orderHeaderList" entry="orderHeader">
                <log message="============================${orderId}======================================"/>
                <set field="orderDetailsMap" from="[orderId:orderHeader.orderId,orderName:orderHeader.orderName,currencyUom:orderHeader.currencyUom,salesChannelEnumId:orderHeader.salesChannelEnumId,
                            statusId:orderHeader.statusId,placedDate:orderHeader.placedDate,grandTotal:orderHeader.grandTotal]"/>
                <entity-find entity-name="OrderPart" list="orderPartList">
                    <econdition field-name="orderId" operator="equals" from="OrderHeader.orderId"/>
                </entity-find>
                <iterate list="orderPartList" entry="orderPart">
                    <set field="orderPartMap" from="[:]"/>
                    <set field="orderPartMap" from="[orderPartSeqId:orderPart.orderPartSeqId,partName:orderPart.partName,facilityId:orderPart.facilityId,shipmentMethodEnumId:orderPart.shipmentMethodEnumId,

                                   partStatusId:orderPart.partStatusId,partTotal:orderPart.partTotal]"/>
                    <script>orderPartList.add(orderPartMap)</script>
                </iterate>

                <entity-find entity-name="Person" list="personList">
                    <econdition field-name="partyId" operator="equals" from="orderPart.customerPartyId"/>
                </entity-find>
                <iterate list="personList" entry="personMap">
                    <set field="personMap" from="[:]"/>
                    <set field="personMap"
                         from="[firstName:person.firstName,middleName:person.middleName,lastName:person.lastName]"/>

                    <script>personList.add(personMap)</script>

                </iterate>
                <entity-find entity-name="OrderItem" list="orderItemList">
                    <econdition field-name="orderPartSeqId" operator="equals" from="OrderPart.orderPartSeqId"/>
                    <econdition field-name="orderId" operator="equals" from="OrderHeader.orderId"/>
                </entity-find>
                <iterate list="orderItemList" entry="orderItem">
                    <set field="orderItemMap" from="[:]"/>
                    <set field="orderItemMap" from="[orderItemSeqId:orderItem.orderItemSeqId,productId:orderItem.productId,itemDescription:order.itemDescription,
                                             quantity:orderItem.quantity,unitAmount:orderItem.unitAmount]"/>

                    <script>orderItemList.add(orderItemMap)</script>

                </iterate>

                <set field="orderMap"
                     from="orderMap + [order_parts:orderPartList, item_details:orderItemList]"/>

                <script>orders.add(orderMap)</script>
            </iterate>


        </actions>

    </service>
</services>
